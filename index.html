<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Project Flow</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&family=Special+Elite&display=swap");

      :root {
        --primary-dark: #3d2b1f;
        --accent-brown: #6f4e37;
        --muted-tan: #c0a080;
        --bg-warm: #d7ccc8;
        --paper-white: #fffcf9;
        --success-green: #7a9a65;
        --border-color: rgba(61, 43, 31, 0.12);
        --radius: 12px;
      }

      * {
        box-sizing: border-box;
        outline: none;
      }

      body {
        font-family: "Quicksand", sans-serif;
        background-color: var(--bg-warm);
        background-image: url("https://www.transparenttextures.com/patterns/p6.png");
        color: var(--primary-dark);
        margin: 0;
        height: 100vh;
        display: flex;
        overflow: hidden;
      }

      /* --- MOBILE WARNING --- */
      #mobile-warning {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: var(--bg-warm);
        background-image: url("https://www.transparenttextures.com/patterns/p6.png");
        z-index: 9999;
        justify-content: center;
        align-items: center;
        text-align: center;
        padding: 20px;
      }

      .warning-content {
        background: var(--paper-white);
        padding: 40px 30px;
        border-radius: var(--radius);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        border-top: 8px solid var(--accent-brown);
        max-width: 320px;
      }

      .warning-content h2 {
        font-family: "Special Elite", cursive;
        color: var(--accent-brown);
        margin: 20px 0 10px;
      }
      .warning-content p {
        font-weight: 600;
        line-height: 1.5;
        color: var(--primary-dark);
        font-size: 14px;
      }

      @media only screen and (max-width: 767px) {
        #mobile-warning {
          display: flex;
        }
      }

      /* --- APP LAYOUT --- */
      .app-container {
        display: grid;
        grid-template-columns: 320px 1fr;
        width: 100%;
        height: 100vh;
        transition: grid-template-columns 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }
      .app-container.collapsed {
        grid-template-columns: 80px 1fr;
      }

      /* --- SIDEBAR --- */
      .sidebar {
        background: var(--paper-white);
        border-right: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
        padding: 25px;
        box-shadow: 10px 0 30px rgba(0, 0, 0, 0.1);
        height: 100vh;
        overflow: hidden;
        position: relative;
        z-index: 10;
      }

      .app-container.collapsed .sidebar > *:not(.collapse-btn) {
        display: none !important;
      }

      .sidebar-header {
        font-family: "Special Elite", cursive;
        font-size: 20px;
        color: var(--accent-brown);
        margin: 40px 0 30px 0;
        border-bottom: 2px dashed var(--muted-tan);
        padding-bottom: 15px;
        letter-spacing: 1px;
        text-align: center;
        width: 100%;
      }

      .input-wrapper {
        margin-bottom: 25px;
      }
      .standard-input {
        width: 100%;
        padding: 14px;
        border: 1.5px solid var(--border-color);
        background: #fdfbf7;
        border-radius: var(--radius);
        font-family: inherit;
        color: var(--primary-dark);
        font-weight: 600;
        transition: all 0.2s;
      }
      .standard-input:focus {
        border-color: var(--muted-tan);
        background: white;
      }

      .project-list {
        overflow-y: auto;
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 10px;
        padding-right: 5px;
      }

      .project-list::-webkit-scrollbar {
        width: 4px;
      }
      .project-list::-webkit-scrollbar-track {
        background: var(--bg-warm);
      }
      .project-list::-webkit-scrollbar-thumb {
        background: var(--muted-tan);
        border-radius: 10px;
      }

      .project-item {
        padding: 15px;
        cursor: pointer;
        border-radius: var(--radius);
        transition: 0.2s;
        display: flex;
        flex-direction: column;
        gap: 4px;
        background: rgba(215, 204, 200, 0.2);
      }
      .project-item:hover {
        background: rgba(215, 204, 200, 0.4);
        transform: translateX(4px);
      }
      .project-item.active {
        background: var(--accent-brown);
        color: white;
        box-shadow: 0 4px 12px rgba(111, 78, 55, 0.3);
      }

      .p-title-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .p-meta {
        font-size: 11px;
        color: inherit;
        opacity: 0.8;
        font-weight: 700;
        text-transform: uppercase;
      }
      .p-actions {
        opacity: 0;
        transition: 0.2s;
      }
      .project-item:hover .p-actions {
        opacity: 1;
      }

      .collapse-btn {
        position: absolute;
        top: 15px;
        left: 15px;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: var(--primary-dark);
        color: var(--paper-white);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 100;
        transition: 0.3s;
      }
      .app-container.collapsed .collapse-btn {
        left: 24px;
      }
      .collapse-btn:hover {
        transform: scale(1.1);
        background: var(--accent-brown);
      }

      /* --- DASHBOARD --- */
      .dashboard-container {
        position: absolute;
        top: 20px;
        right: 40px;
        background: var(--paper-white);
        border: 1px solid var(--border-color);
        padding: 15px 20px;
        border-radius: var(--radius);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        display: flex;
        flex-direction: column;
        align-items: center;
        min-width: 220px;
        gap: 15px;
        z-index: 1;
      }
      .dash-title {
        font-size: 10px;
        font-weight: 800;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--muted-tan);
        width: 100%;
        text-align: center;
        margin-bottom: 20px;
      }
      .dash-grid {
        display: flex;
        gap: 12px;
        align-items: flex-end;
        height: 50px;
      }
      .dash-day {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 5px;
      }
      .dash-bar {
        width: 12px;
        background: #eee;
        border-radius: 4px;
        position: relative;
        height: 40px;
        overflow: hidden;
      }
      .dash-bar-fill {
        position: absolute;
        bottom: 0;
        width: 100%;
        background: var(--success-green);
        transition: height 0.5s ease;
      }
      .dash-label {
        font-size: 9px;
        font-weight: 700;
        color: var(--muted-tan);
      }
      .dash-count {
        font-size: 9px;
        font-weight: 800;
        color: var(--accent-brown);
      }

      /* --- MAIN VIEW --- */
      .main-view {
        padding: 60px 40px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
        position: relative;
      }

      .notebook {
        background: var(--paper-white);
        width: 100%;
        max-width: 800px;

        /* UPDATED: Height is relative to the screen height */
        height: calc(100vh - 120px);
        margin: 0 auto;

        border-radius: 2px;
        padding: 40px 50px;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.1);
        border-left: 45px solid #dcd3cb;
        position: relative;

        /* ADDED: This makes the inside of the notebook behave like a column */
        display: flex;
        flex-direction: column;
      }

      .notebook-header {
        display: flex;
        flex-direction: column; /* Stack Title and Description vertically */
        align-items: flex-start;
        margin-bottom: 30px;
        border-bottom: 2px solid #f5f1ed;
        padding-bottom: 20px;
      }

      #panel-title {
        margin: 0;
        font-family: "Special Elite", cursive;
        font-size: 32px;
        color: var(--primary-dark);
        cursor: pointer;
      }

      #tasks-content,
      #notes-content,
      #learnings-content,
      #issues-content,
      #planner-content {
        flex: 1;
        overflow-y: auto;
        padding-right: 10px;
      }

      #tasks-content::-webkit-scrollbar,
      #notes-content::-webkit-scrollbar,
      #learnings-content::-webkit-scrollbar,
      #issues-content::-webkit-scrollbar,
      #planner-content::-webkit-scrollbar {
        width: 5px;
      }

      #tasks-content::-webkit-scrollbar-thumb,
      #notes-content::-webkit-scrollbar-thumb,
      #learnings-content::-webkit-scrollbar-thumb,
      #issues-content::-webkit-scrollbar-thumb,
      #planner-content::-webkit-scrollbar-thumb {
        background: var(--muted-tan);
        border-radius: 10px;
      }

      .timer-display {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        border: 4px solid #f5f1ed;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        background: white;
        color: var(--accent-brown);
        font-family: "Special Elite", cursive;
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      }
      .timer-display.active {
        border-color: var(--success-green);
        transform: scale(1.1);
        color: var(--success-green);
      }

      .task-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 16px 0;
        border-bottom: 1px solid #f5f1ed;
      }
      .task-text {
        flex: 1;
        font-weight: 600;
        font-size: 17px;
        cursor: pointer;
      }
      .task-text.done {
        text-decoration: line-through;
        opacity: 0.4;
        color: var(--accent-brown);
      }

      .tabs {
        display: flex;
        gap: 30px;
        margin-bottom: 30px;
      }
      .tab {
        cursor: pointer;
        font-weight: 700;
        color: var(--muted-tan);
        padding-bottom: 8px;
        border-bottom: 3px solid transparent;
        text-transform: uppercase;
        font-size: 13px;
      }
      .tab.active {
        color: var(--accent-brown);
        border-bottom-color: var(--accent-brown);
      }

      .notes-toolbar {
        display: flex;
        justify-content: flex-end;
        margin-bottom: 15px;
        margin-top: 5px;
      }
      .btn-toggle-icon {
        background: var(--muted-tan);
        color: white;
        border: none;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: 0.2s;
        font-size: 14px;
      }
      .btn-toggle-icon:hover {
        background: var(--accent-brown);
        transform: scale(1.1);
      }
      .notes-area,
      .markdown-body {
        width: 100%;
        /* Remove height: 450px or 100% */
        height: auto;
        min-height: 100%; /* Ensures it fills the space if empty */
        overflow-y: visible; /* Prevent the inner scrollbar from appearing */

        font-family: inherit;
        font-size: 15px;
        line-height: 1.8;
        color: #4a372d;
        border: none;
        background: transparent;
        resize: none;
      }

      #notes-content {
        flex: 1;
        overflow-y: auto; /* This keeps your aesthetic scrollbar */
        padding-right: 15px;
      }

      /* --- MARKDOWN STYLING (Including Tables) --- */

      .markdown-body table {
        border-collapse: collapse;
        width: 100%;
        margin-bottom: 1rem;
        background-color: transparent;
        border: 1px solid var(--border-color);
      }
      .markdown-body th,
      .markdown-body td {
        border: 1px solid var(--border-color);
        padding: 12px;
        text-align: left;
      }
      .markdown-body th {
        background-color: rgba(215, 204, 200, 0.2);
        font-weight: 700;
        color: var(--accent-brown);
      }
      .markdown-body tr:nth-child(even) {
        background-color: rgba(215, 204, 200, 0.05);
      }

      /* --- MODALS --- */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(45, 30, 23, 0.6);
        backdrop-filter: blur(4px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }
      .modal-content {
        background: var(--paper-white);
        padding: 40px;
        border-radius: var(--radius);
        width: 450px; /* This is the default, but our Guide overrides it inline */
        box-shadow: 0 40px 100px rgba(0, 0, 0, 0.2);
        border-top: 10px solid var(--accent-brown);
        position: relative;

        /* ADD THESE LINES */
        max-height: 90vh; /* Ensures it doesn't exceed 90% of screen height */
        overflow-y: auto; /* Adds a scrollbar if content is too tall */
      }

      .modal-content::-webkit-scrollbar {
        width: 6px;
      }
      .modal-content::-webkit-scrollbar-thumb {
        background: var(--muted-tan);
        border-radius: 10px;
      }

      kbd {
        background-color: #eee;
        border-radius: 3px;
        border: 1px solid #b4b4b4;
        box-shadow:
          0 1px 1px rgba(0, 0, 0, 0.2),
          0 2px 0 0 rgba(255, 255, 255, 0.7) inset;
        color: #333;
        display: inline-block;
        font-size: 0.85em;
        font-weight: 700;
        line-height: 1;
        padding: 2px 4px;
        white-space: nowrap;
      }

      .guide-step {
        background: #fdfbf7;
        padding: 15px;
        border-radius: 8px;
        border-left: 4px solid var(--accent-brown);
        margin-bottom: 15px;
        font-size: 14px;
        line-height: 1.5;
      }
      .guide-step b {
        color: var(--accent-brown);
      }

      .shortcut-legend {
        margin-top: 25px;
        padding-top: 20px;
        border-top: 1px solid var(--border-color);
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
      }
      .shortcut-item {
        font-size: 12px;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 8px;
        color: var(--primary-dark);
      }

      .btn-action {
        background: var(--success-green);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 30px;
        font-weight: 700;
        cursor: pointer;
        transition: 0.2s;
      }
      .btn-action:hover {
        transform: translateY(-2px);
      }

      .hidden {
        display: none !important;
      }

      .project-item.active .p-member-list {
        color: var(--paper-white) !important;
        opacity: 0.9;
      }

      .p-member-list {
        font-size: 10px;
        margin-top: 5px;
        color: var(--accent-brown); /* Default color for non-active items */
        font-weight: bold;
        transition: color 0.2s;
      }

      .issue-tooltip {
        position: absolute;
        background: var(--paper-white);
        border: 1px solid var(--accent-brown);
        padding: 12px 16px;
        border-radius: 8px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
        font-size: 13px;
        z-index: 9999;
        max-width: 280px;
        color: var(--primary-dark);
        line-height: 1.5;
        border-top: 4px solid var(--accent-brown);
        /* Remove pointer-events: none to allow interaction if needed */
        pointer-events: auto;
        /* Prevent the tooltip from flickering when appearing */
        transition: opacity 0.2s ease;
      }

      .tooltip-status {
        display: block;
        font-size: 9px;
        font-weight: 800;
        text-transform: uppercase;
        margin-bottom: 4px;
      }

      .p-actions .btn-icon:hover {
        color: var(--success-green) !important;
      }

      /* --- ISSUE DROPDOWN MENU --- */
      .issue-menu-container {
        position: relative;
        display: inline-block;
      }

      .menu-trigger {
        background: none;
        border: none;
        color: var(--muted-tan);
        cursor: pointer;
        padding: 10px;
        font-size: 18px;
        transition: color 0.2s;
      }

      .menu-trigger:hover {
        color: var(--accent-brown);
      }

      .issue-dropdown {
        display: none;
        position: absolute;
        right: 0;
        top: 100%;
        background: var(--paper-white);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        min-width: 160px;
        overflow: hidden;
      }

      .issue-dropdown.show {
        display: block;
      }

      .menu-item {
        padding: 12px 16px;
        font-size: 13px;
        font-weight: 600;
        color: var(--primary-dark);
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 10px;
        transition: background 0.2s;
      }

      .menu-item:hover {
        background: rgba(215, 204, 200, 0.2);
      }

      .menu-item i {
        width: 16px;
        color: var(--muted-tan);
      }

      .menu-item.delete-item {
        color: #a66363;
        border-top: 1px solid var(--border-color);
      }

      .control-tower {
        position: fixed; /* Keeps it pinned while you scroll the notebook */
        right: 30px;
        top: 20px;
        width: 260px;
        display: flex;
        flex-direction: column;
        gap: 15px;
        z-index: 100;
      }

      .insight-section {
        background: var(--paper-white);
        border: 1px solid var(--border-color);
        border-radius: var(--radius);
        padding: 20px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
      }

      /* Specific styling for the Pomo/Chart widget */
      .dashboard-widget {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 15px;
      }

      .insight-header {
        font-family: "Special Elite", cursive;
        font-size: 11px;
        margin: 0 0 12px 0;
        color: var(--accent-brown);
        border-bottom: 1px dashed var(--muted-tan);
        padding-bottom: 6px;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .insight-stat-item {
        font-size: 12px;
        font-weight: 700;
        margin-bottom: 8px;
        display: flex;
        justify-content: space-between;
      }

      .chronology-list {
        max-height: calc(100vh - 450px); /* Adjusts based on screen height */
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .chronology-item {
        border-left: 3px solid var(--muted-tan);
        padding-left: 10px;
        cursor: pointer;
        transition: transform 0.2s;
      }

      .chronology-item:hover {
        transform: none;
        border-left-color: var(--accent-brown);
      }

      .chronology-item b {
        display: block;
        font-size: 12px;
        color: var(--primary-dark);
      }

      .chronology-item span {
        color: var(--accent-brown);
        font-size: 10px;
        font-weight: 700;
      }

      .input-group {
        position: relative;
        display: flex;
        flex: 2.5; /* Matches your previous layout ratio */
      }

      .input-group .standard-input {
        padding-right: 35px; /* Make room so text doesn't overlap the icon */
        width: 100%;
      }

      .enter-icon {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--muted-tan);
        opacity: 0.5;
        font-family: "Quicksand", sans-serif;
        pointer-events: none; /* User clicks "through" it to the input */
        font-size: 18px;
      }

      /* Ensure the Actions input follows the same theme as others */
      #action-input {
        background: #fdfbf7 !important; /* Dull tan/warm background */
        transition: all 0.2s ease;
      }

      #action-input:focus {
        background: white !important; /* Bright white on focus */
        border-color: var(--muted-tan) !important;
        box-shadow: 0 0 8px rgba(192, 160, 128, 0.2);
      }
      .input-group {
        position: relative;
      }

      /* Subtle shortcut hint inside the input */
      .shortcut-hint {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        background: #eee;
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 2px 6px;
        font-size: 10px;
        font-weight: bold;
        color: #888;
        pointer-events: none; /* User clicks "through" it */
        font-family: monospace;
        transition: opacity 0.2s;
      }

      /* Hide the hint when the user is typing or the input is focused */
      .standard-input:focus + .shortcut-hint,
      .standard-input:not(:placeholder-shown) + .shortcut-hint {
        opacity: 0;
      }
      /* Container to hold input and badge */
      .input-wrapper {
        position: relative;
        display: flex;
        align-items: center;
      }

      /* The shortcut badge */
      .kbd-badge,
      .shortcut-hint,
      .enter-icon {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        display: flex;
        align-items: center;
        justify-content: center;
        pointer-events: none;
        line-height: 1; /* Prevents text height from pushing the box down */
      }

      /* Hide badge when user clicks/focuses or types */
      .standard-input:focus + .kbd-badge,
      .standard-input:not(:placeholder-shown) + .kbd-badge {
        opacity: 0;
      }

      /* Suggestion Dropdown Container */
      .suggestion-menu {
        position: absolute;
        background: var(--paper-white);
        border: 1px solid var(--accent-brown);
        border-radius: 8px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        z-index: 10000;
        max-height: 200px;
        overflow-y: auto;
        min-width: 250px;
      }

      .suggestion-item {
        padding: 10px 14px;
        cursor: pointer;
        font-size: 13px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        gap: 10px;
      }

      .suggestion-item:last-child {
        border-bottom: none;
      }

      .suggestion-item:hover,
      .suggestion-item.selected {
        background: rgba(111, 78, 55, 0.1);
      }

      .suggestion-item b {
        color: var(--accent-brown);
        font-family: "Special Elite", monospace;
      }
      .kbd-badge,
      .shortcut-hint {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);

        /* The "Box" Look */
        background: #f0ece8;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        padding: 2px 6px;

        /* Typography */
        font-size: 11px;
        font-weight: 700;
        color: var(--muted-tan);
        font-family: monospace;
        line-height: 1;

        /* Alignment */
        display: flex;
        align-items: center;
        justify-content: center;
        pointer-events: none;
        transition: opacity 0.2s ease;
        box-shadow: 0 1px 0 rgba(0, 0, 0, 0.05);
      }

      /* Hide when typing */
      .standard-input:focus + .kbd-badge,
      .standard-input:not(:placeholder-shown) + .kbd-badge,
      .standard-input:focus + .shortcut-hint,
      .standard-input:not(:placeholder-shown) + .shortcut-hint {
        opacity: 0;
      }
    </style>
  </head>
  <body onkeydown="handleGlobalKeys(event)">
    <div id="mobile-warning">
      <div class="warning-content">
        <i class="fas fa-desktop fa-3x" style="color: var(--muted-tan)"></i>
        <h2>Desktop Preferred</h2>
        <p>
          Project Flow is optimized for larger screens. Please switch to a
          computer or tablet for the best experience.
        </p>
      </div>
    </div>
    <div id="guide-modal" class="modal-overlay hidden">
      <div class="modal-content" style="width: 850px; max-width: 90vw">
        <h2
          style="
            font-family: &quot;Special Elite&quot;;
            color: var(--accent-brown);
            text-align: center;
            margin-bottom: 25px;
          "
        >
          The Project Flow
        </h2>

        <div
          style="
            display: flex;
            align-items: flex-start;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            padding: 30px 20px;
            background: rgba(215, 204, 200, 0.1);
            border-radius: 12px;
            border: 1px dashed var(--muted-tan);
          "
        >
          <div
            style="
              display: flex;
              flex-direction: column;
              align-items: center;
              width: 150px;
            "
          >
            <div
              style="
                background: #a66363;
                color: white;
                width: 100%;
                padding: 12px 0;
                border-radius: 8px;
                font-weight: bold;
                font-size: 13px;
                text-align: center;
                box-shadow: 0 4px 0 #854d4d;
              "
            >
              QUEST
            </div>
            <p
              style="
                font-size: 11px;
                margin-top: 12px;
                color: var(--primary-dark);
                line-height: 1.4;
                text-align: center;
              "
            >
              Define the<br /><b>Question</b>
            </p>
          </div>

          <i
            class="fas fa-chevron-right"
            style="
              color: var(--muted-tan);
              font-size: 18px;
              margin-top: 15px;
              padding: 0 5px;
            "
          ></i>

          <div
            style="
              display: flex;
              flex-direction: column;
              align-items: center;
              width: 150px;
            "
          >
            <div
              style="
                background: var(--muted-tan);
                color: white;
                width: 100%;
                padding: 12px 0;
                border-radius: 8px;
                font-weight: bold;
                font-size: 13px;
                text-align: center;
                box-shadow: 0 4px 0 #a88a6a;
              "
            >
              ACTIONS
            </div>
            <p
              style="
                font-size: 11px;
                margin-top: 12px;
                color: var(--primary-dark);
                line-height: 1.4;
                text-align: center;
              "
            >
              Define steps to find<br />the <b>Answer</b>
            </p>
          </div>

          <i
            class="fas fa-chevron-right"
            style="
              color: var(--muted-tan);
              font-size: 18px;
              margin-top: 15px;
              padding: 0 5px;
            "
          ></i>

          <div
            style="
              display: flex;
              flex-direction: column;
              align-items: center;
              width: 150px;
            "
          >
            <div
              style="
                background: var(--success-green);
                color: white;
                width: 100%;
                padding: 12px 0;
                border-radius: 8px;
                font-weight: bold;
                font-size: 13px;
                text-align: center;
                box-shadow: 0 4px 0 #617c50;
              "
            >
              LEARNING
            </div>
            <p
              style="
                font-size: 11px;
                margin-top: 12px;
                color: var(--primary-dark);
                line-height: 1.4;
                text-align: center;
              "
            >
              Log the<br /><b>Discovery</b>
            </p>
          </div>
        </div>

        <div
          style="
            background: #fdfbf7;
            border-left: 4px solid var(--muted-tan);
            padding: 20px;
            margin-bottom: 25px;
            border-radius: 0 8px 8px 0;
          "
        >
          <h5
            style="
              margin: 0 0 12px 0;
              text-transform: uppercase;
              font-size: 11px;
              letter-spacing: 1px;
              color: var(--accent-brown);
            "
          >
            Workflow Example:
          </h5>
          <div
            style="
              font-size: 13px;
              line-height: 1.6;
              color: var(--primary-dark);
            "
          >
            <div style="margin-bottom: 6px">
              <i
                class="fas fa-question-circle"
                style="color: #a66363; width: 20px"
              ></i>
              <b>Quest:</b> "Why is the API token expiring every 5 minutes?"
            </div>
            <div style="margin-bottom: 6px">
              <i
                class="fas fa-vial"
                style="color: var(--muted-tan); width: 20px"
              ></i>
              <b>Action:</b> "Verify the 'expires_in' value in the OAuth
              provider dashboard."
            </div>
            <div>
              <i
                class="fas fa-check-circle"
                style="color: var(--success-green); width: 20px"
              ></i>
              <b>Learning:</b> "Provider defaults to UTC-8; server clock was out
              of sync, causing instant expiry."
            </div>
          </div>
        </div>

        <h4
          style="
            margin: 25px 0 15px 0;
            text-transform: uppercase;
            font-size: 10px;
            letter-spacing: 2px;
            color: var(--muted-tan);
            text-align: center;
            border-top: 1px solid var(--border-color);
            padding-top: 20px;
          "
        >
          System Navigation
        </h4>
        <div
          class="shortcut-legend"
          style="
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            background: white;
            padding: 15px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
          "
        >
          <div class="shortcut-item">
            <kbd>‚Üë</kbd> <kbd>‚Üì</kbd> <span>Select Project</span>
          </div>
          <div class="shortcut-item">
            <kbd>‚Üê</kbd> <kbd>‚Üí</kbd> <span>Switch Tabs</span>
          </div>
          <div class="shortcut-item">
            <kbd>Enter</kbd> <span>Input Mode</span>
          </div>
          <div class="shortcut-item"><kbd>/</kbd> <span>New Project</span></div>
          <div class="shortcut-item">
            <kbd>Esc</kbd> <span>Unfocus / Clear</span>
          </div>
        </div>

        <div style="margin-top: 30px; display: flex; justify-content: center">
          <button
            class="btn-action"
            onclick="closeGuide()"
            style="padding: 14px 50px; font-size: 15px; letter-spacing: 1px"
          >
            READY TO FLOW
          </button>
        </div>
      </div>
    </div>

    <div class="app-container" id="app-shell">
      <aside class="sidebar">
        <div
          class="collapse-btn"
          onclick="toggleSidebar()"
          title="Toggle Sidebar"
        >
          <i class="fas fa-bars"></i>
        </div>

        <div class="sidebar-header">Project Flow</div>

        <div class="input-wrapper">
          <input
            type="text"
            id="project-input"
            class="standard-input"
            placeholder="New Project..."
          />
          <span class="kbd-badge">/</span>
        </div>
        <div class="project-list" id="projects-grid"></div>

        <div
          class="sidebar-footer"
          style="
            margin-top: auto;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
            padding-top: 20px;
          "
        >
          <button
            class="standard-input"
            style="cursor: pointer; font-size: 11px; padding: 10px 5px"
            onclick="exportData()"
          >
            Export All
          </button>
          <button
            class="standard-input"
            style="cursor: pointer; font-size: 11px; padding: 10px 5px"
            onclick="document.getElementById('import-file-input').click()"
          >
            Import
          </button>
          <button
            class="standard-input"
            style="cursor: pointer; font-size: 11px; padding: 10px 5px"
            onclick="showGuide()"
          >
            Quick Guide
          </button>
          <input
            type="file"
            id="import-file-input"
            class="hidden"
            accept=".json"
            onchange="handleImport(event)"
          />
        </div>
      </aside>
      <main class="main-view">
        <aside class="control-tower">
          <div class="insight-section dashboard-widget">
            <div class="dash-title">Last 7 Days Focus</div>
            <div class="dash-grid" id="dash-grid"></div>
            <div
              id="timer-display-box"
              class="timer-display"
              title="Click: Start | Hold: Set Time"
            >
              <span
                id="timer-display"
                style="font-size: 18px; font-weight: bold"
                >25:00</span
              >
            </div>
          </div>

          <div class="insight-section">
            <h4 class="insight-header">
              <i class="fas fa-chart-line"></i> Global Status
            </h4>
            <div id="global-stats-content"></div>
          </div>

          <div class="insight-section">
            <h4 class="insight-header">
              <i class="fas fa-calendar-check"></i> Master Schedule
            </h4>
            <div id="global-schedule-content" class="chronology-list"></div>
          </div>
        </aside>

        <div
          id="empty-state"
          style="
            text-align: center;
            margin-top: 100px;
            color: var(--primary-dark);
          "
        >
          <i
            class="fas fa-feather-alt fa-4x"
            style="opacity: 0.3; margin-bottom: 20px"
          ></i>
          <p style="font-size: 20px; font-weight: 600; opacity: 0.6">
            Select a project to begin.
          </p>
        </div>

        <div id="actions-panel" class="notebook hidden">
          <div class="notebook-header">
            <div style="flex: 1">
              <h1 id="panel-title" onclick="editActiveProjectName()"></h1>
              <div
                id="project-stats"
                style="
                  font-size: 13px;
                  font-weight: 700;
                  color: var(--muted-tan);
                  margin-top: 5px;
                  text-transform: uppercase;
                "
              ></div>
            </div>
          </div>

          <div class="tabs">
            <div
              class="tab active"
              onclick="switchTab('quests')"
              id="tab-quests"
            >
              Quests
            </div>
            <div class="tab" onclick="switchTab('tasks')" id="tab-tasks">
              Actions
            </div>
            <div
              class="tab"
              onclick="switchTab('learnings')"
              id="tab-learnings"
            >
              Learnings
            </div>
            <div class="tab" onclick="switchTab('notes')" id="tab-notes">
              Notes
            </div>
            <div class="tab" onclick="switchTab('meetings')" id="tab-meetings">
              Meetings
            </div>
          </div>

          <div id="quests-content">
            <div style="display: flex; gap: 10px; margin-bottom: 20px">
              <div class="input-group">
                <input
                  type="text"
                  id="issue-input"
                  class="standard-input"
                  placeholder="+ Add Quest..."
                  oninput="handleAutocomplete(event)"
                  onblur="setTimeout(removeSuggestionMenu, 200)"
                  onkeydown="if (event.key === 'Enter') addIssue();"
                />
                <span class="enter-icon">‚Üµ</span>
              </div>
            </div>
            <div id="issues-list"></div>
          </div>

          <div id="tasks-content" class="hidden">
            <div style="display: flex; gap: 10px; margin-bottom: 20px">
              <div class="input-group">
                <input
                  type="text"
                  id="action-input"
                  class="standard-input"
                  placeholder="+ Add Actionable Task..."
                  oninput="handleAutocomplete(event)"
                  onblur="setTimeout(removeSuggestionMenu, 200)"
                />
                <span class="enter-icon">‚Üµ</span>
              </div>
              <div class="input-group">
                <input
                  type="text"
                  id="action-search"
                  class="standard-input"
                  placeholder="üîç Search..."
                  oninput="
                    renderActions();
                    handleAutocomplete(event);
                  "
                  onblur="setTimeout(removeSuggestionMenu, 200)"
                />
                <span class="shortcut-hint">\</span>
              </div>
            </div>
            <div id="active-actions"></div>
            <div
              id="archived-actions"
              style="
                margin-top: 40px;
                border-top: 2px dashed var(--border-color);
                padding-top: 20px;
              "
            ></div>
          </div>

          <div id="learnings-content" class="hidden">
            <div style="display: flex; gap: 10px; margin-bottom: 20px">
              <div class="input-group" style="flex: 2.5">
                <input
                  type="text"
                  id="learning-desc-input"
                  class="standard-input"
                  placeholder="+ Add Learnings..."
                  oninput="handleAutocomplete(event)"
                  onblur="setTimeout(removeSuggestionMenu, 200)"
                  onkeydown="
                    if (event.key === 'Enter') {
                      event.preventDefault();
                      addLearning();
                    }
                  "
                />
                <span class="enter-icon">‚Üµ</span>
              </div>

              <div class="input-group" style="flex: 1">
                <input
                  type="text"
                  id="learning-search"
                  class="standard-input"
                  placeholder="üîç Search..."
                  oninput="
                    renderActions();
                    handleAutocomplete(event);
                  "
                  onblur="setTimeout(removeSuggestionMenu, 200)"
                />
                <span class="kbd-badge">\</span>
              </div>
            </div>
            <div id="learnings-list"></div>
          </div>

          <div id="notes-content" class="hidden">
            <div class="notes-toolbar">
              <button
                class="btn-toggle-icon"
                onclick="toggleMarkdown()"
                title="Toggle Edit/Preview"
              >
                <i id="toggle-icon" class="fas fa-pen"></i>
              </button>
            </div>
            <textarea
              id="notes-area"
              class="notes-area hidden"
              oninput="updateNotes()"
              placeholder="Write your thoughts here... (Markdown supported)"
            ></textarea>
            <div id="markdown-view" class="markdown-body"></div>
          </div>

          <div id="meetings-content" class="hidden">
            <div
              style="
                display: flex;
                flex-direction: column;
                gap: 10px;
                margin-bottom: 20px;
                background: rgba(111, 78, 55, 0.05);
                padding: 15px;
                border-radius: var(--radius);
                border: 1.5px solid var(--border-color);
              "
            >
              <div
                style="
                  display: grid;
                  grid-template-columns: 1fr 1fr 1fr;
                  gap: 10px;
                "
              >
                <input type="date" id="plan-date" class="standard-input" />
                <input type="time" id="plan-time" class="standard-input" />

                <div class="input-group">
                  <input
                    type="text"
                    id="plan-search"
                    class="standard-input"
                    placeholder="üîç Search..."
                    oninput="
                      renderActions();
                      handleAutocomplete(event);
                    "
                    onblur="setTimeout(removeSuggestionMenu, 200)"
                  />
                  <span class="shortcut-hint">\</span>
                </div>
              </div>

              <div class="input-group" style="flex: 1">
                <input
                  type="text"
                  id="plan-desc"
                  class="standard-input"
                  placeholder="Meeting Title..."
                  oninput="handleAutocomplete(event)"
                  onblur="setTimeout(removeSuggestionMenu, 200)"
                  onkeydown="if (event.key === 'Enter') addMeeting();"
                />
                <span class="enter-icon">‚Üµ</span>
              </div>
            </div>
            <div id="meetings-list"></div>
          </div>
        </div>
      </main>
    </div>

    <div id="custom-modal" class="modal-overlay hidden">
      <div class="modal-content">
        <h3
          class="modal-title"
          id="modal-title"
          style="
            font-family: &quot;Special Elite&quot;;
            font-size: 22px;
            margin-top: 0;
          "
        >
          Edit
        </h3>
        <input
          type="text"
          id="modal-input"
          class="standard-input"
          style="background: white; margin-bottom: 20px"
        />
        <div style="display: flex; justify-content: flex-end; gap: 12px">
          <button
            class="btn-action"
            style="background: var(--muted-tan)"
            onclick="closeModal()"
          >
            Cancel
          </button>
          <button class="btn-action" id="modal-confirm-btn">Confirm</button>
        </div>
      </div>
    </div>
    <div id="reschedule-modal" class="modal-overlay hidden">
      <div class="modal-content">
        <h3
          style="
            font-family: &quot;Special Elite&quot;;
            font-size: 22px;
            margin-top: 0;
          "
        >
          Reschedule Meeting
        </h3>
        <div style="display: flex; gap: 10px; margin-bottom: 20px">
          <div style="flex: 1">
            <label
              style="font-size: 11px; font-weight: 800; color: var(--muted-tan)"
              >NEW DATE</label
            >
            <input type="date" id="resched-date" class="standard-input" />
          </div>
          <div style="flex: 1">
            <label
              style="font-size: 11px; font-weight: 800; color: var(--muted-tan)"
              >NEW TIME</label
            >
            <input type="time" id="resched-time" class="standard-input" />
          </div>
        </div>
        <div style="display: flex; justify-content: flex-end; gap: 12px">
          <button
            class="btn-action"
            style="background: var(--muted-tan)"
            onclick="closeRescheduleModal()"
          >
            Cancel
          </button>
          <button class="btn-action" id="resched-confirm-btn">
            Update Schedule
          </button>
        </div>
      </div>
    </div>

    <script>
      const DEFAULT_MD = `# Project Notes\nUse this space for notes.\n\n### Quick Guide\n- **Bold** for emphasis\n- [Link](https://google.com)\n\n| Task | Status |\n| :--- | :--- |\n| Research | Done |\n| Build | Active |\n\nClick the **pencil icon** above to start writing.`;

      let projects = JSON.parse(localStorage.getItem("pf-v12")) || [];
      let pomoHistory = JSON.parse(localStorage.getItem("pf-pomo-v12")) || [];
      let activeId = null;
      let dragSource = null;
      let isModalOpen = false;
      let isMarkdownMode = true;

      let defaultMins = 25;
      let pomoSecs = defaultMins * 60;
      let pomoTimer = null;
      let isPomoRunning = false;
      let longHoldTimer = null;
      let currentSuggestionIdx = 0;
      let suggestionMenu = null;

      function handleAutocomplete(e) {
        const input = e.target;
        const val = input.value;
        const cursorPos = input.selectionStart;

        // 1. Look for the last "#" before the cursor
        const lastHash = val.lastIndexOf("#", cursorPos - 1);

        // 2. Trigger if "#" is found AND it's at the start of a word (preceded by space or start of line)
        const charBeforeHash = val.charAt(lastHash - 1);
        const isStartOfWord = lastHash === 0 || /\s/.test(charBeforeHash);

        if (
          lastHash !== -1 &&
          isStartOfWord &&
          !val.substring(lastHash, cursorPos).includes(" ")
        ) {
          const query = val.substring(lastHash + 1, cursorPos).toLowerCase();
          showSuggestions(input, lastHash, query);
        } else {
          removeSuggestionMenu();
        }
      }

      function selectSuggestion(input, hashIndex, displayId) {
        const val = input.value;
        const cursorPos = input.selectionStart;

        // We remove the "#" typed and replace it with "[#101]" (or your preferred format)
        const before = val.substring(0, hashIndex);
        const after = val.substring(cursorPos);

        // This wraps it in brackets automatically so your 'linkify' function
        // can still detect it as a clickable link later!
        input.value = `${before}[${displayId}] ${after}`;

        removeSuggestionMenu();
        input.focus();
      }

      function showSuggestions(input, index, query) {
        removeSuggestionMenu();

        const p = projects.find((x) => x.id === activeId);
        if (!p || !p.issues) return;

        // UPDATED: Added filter to only show 'open' issues
        const matches = p.issues.filter(
          (i) =>
            i.status === "open" &&
            (i.issueIdDisplay.toLowerCase().includes(query) ||
              i.text.toLowerCase().includes(query)),
        );

        if (matches.length === 0) return;

        suggestionMenu = document.createElement("div");
        suggestionMenu.className = "suggestion-menu";

        const rect = input.getBoundingClientRect();
        suggestionMenu.style.left = `${rect.left + window.scrollX}px`;
        suggestionMenu.style.top = `${rect.bottom + window.scrollY + 5}px`;

        matches.forEach((m) => {
          const item = document.createElement("div");
          item.className = "suggestion-item";
          item.innerHTML = `<b>${m.issueIdDisplay}</b> <span>${m.text}</span>`;
          // We pass the displayId (#101) to the selection function
          item.onclick = () => selectSuggestion(input, index, m.issueIdDisplay);
          suggestionMenu.appendChild(item);
        });

        document.body.appendChild(suggestionMenu);
      }

      function removeSuggestionMenu() {
        if (suggestionMenu) {
          suggestionMenu.remove();
          suggestionMenu = null;
        }
      }

      function init() {
        render();
        setupPomoEvents();
        renderDashboard();
        checkFirstRun();
      }

      function checkFirstRun() {
        if (!localStorage.getItem("pf-visited")) {
          showGuide();
          localStorage.setItem("pf-visited", "true");
        }
      }

      function showGuide() {
        document.getElementById("guide-modal").classList.remove("hidden");
        isModalOpen = true;
      }

      function closeGuide() {
        document.getElementById("guide-modal").classList.add("hidden");
        isModalOpen = false;
        setTimeout(() => document.getElementById("project-input").focus(), 300);
      }

      function playAlertSound() {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        function playNote(freq, start, duration) {
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();
          osc.type = "sine";
          osc.frequency.setValueAtTime(freq, start);
          gain.gain.setValueAtTime(0, start);
          gain.gain.linearRampToValueAtTime(0.1, start + 0.05);
          gain.gain.exponentialRampToValueAtTime(0.01, start + duration);
          osc.connect(gain);
          gain.connect(ctx.destination);
          osc.start(start);
          osc.stop(start + duration);
        }
        const now = ctx.currentTime;
        playNote(659.25, now, 0.5);
        playNote(783.99, now + 0.15, 0.5);
        playNote(1318.51, now + 0.3, 0.8);
      }

      function toggleSidebar() {
        document.getElementById("app-shell").classList.toggle("collapsed");
      }

      function openBrewModal(title, defaultValue, callback, isPrompt = true) {
        isModalOpen = true;
        const modal = document.getElementById("custom-modal");
        const input = document.getElementById("modal-input");
        document.getElementById("modal-title").innerText = title;
        if (isPrompt) {
          input.classList.remove("hidden");
          input.value = defaultValue;
          setTimeout(() => input.focus(), 50);
        } else {
          input.classList.add("hidden");
        }
        modal.classList.remove("hidden");
        const confirm = () => {
          callback(isPrompt ? input.value : true);
          closeModal();
        };
        document.getElementById("modal-confirm-btn").onclick = confirm;
        input.onkeydown = (e) => {
          if (e.key === "Enter") confirm();
          if (e.key === "Escape") {
            e.stopPropagation();
            closeModal();
          }
        };
      }

      function closeModal() {
        document.getElementById("custom-modal").classList.add("hidden");
        isModalOpen = false;
      }

      function setupPomoEvents() {
        const box = document.getElementById("timer-display-box");
        box.onmousedown = () => {
          longHoldTimer = setTimeout(() => {
            openBrewModal("Set Duration (mins)", defaultMins, (val) => {
              if (val && !isNaN(val)) {
                defaultMins = parseInt(val);
                pomoSecs = defaultMins * 60;
                updateTimerDisplay();
              }
            });
            box.dataset.isLongHold = "true";
          }, 700);
        };
        box.onmouseup = () => {
          clearTimeout(longHoldTimer);
          if (box.dataset.isLongHold !== "true") togglePomo();
          box.dataset.isLongHold = "false";
        };
      }

      function togglePomo() {
        if (isPomoRunning) {
          clearInterval(pomoTimer);
          isPomoRunning = false;
          document.title = "Project Flow";
        } else {
          isPomoRunning = true;
          pomoTimer = setInterval(() => {
            pomoSecs--;
            if (pomoSecs <= 0) {
              clearInterval(pomoTimer);
              isPomoRunning = false;
              pomoHistory.push(Date.now());
              save();
              playAlertSound();
              alert("Focus session complete!");
              pomoSecs = defaultMins * 60;
            }
            updateTimerDisplay();
          }, 1000);
        }
        updateTimerDisplay();
      }

      function updateTimerDisplay() {
        const m = Math.floor(pomoSecs / 60),
          s = pomoSecs % 60;
        const timeStr = `${String(m).padStart(2, "0")}:${String(s).padStart(
          2,
          "0",
        )}`;
        const timerDisplay = document.getElementById("timer-display");
        if (timerDisplay) timerDisplay.innerText = timeStr;
        const timerBox = document.getElementById("timer-display-box");
        if (timerBox) timerBox.classList.toggle("active", isPomoRunning);
        if (isPomoRunning) {
          const p = projects.find((x) => x.id === activeId);
          document.title = `(${timeStr}) ${p ? p.name : "Active"}`;
        } else {
          document.title = "Project Flow";
        }
      }

      function renderGlobalInsights() {
        const statsContent = document.getElementById("global-stats-content");
        const scheduleContent = document.getElementById(
          "global-schedule-content",
        );

        let totalPending = 0;
        let totalIssues = 0;
        let allMeetings = [];

        projects.forEach((p) => {
          totalPending += p.actions.filter((a) => !a.done).length;
          totalIssues += (p.issues || []).filter(
            (i) => i.status === "open",
          ).length;

          if (p.meetings) {
            p.meetings.forEach((m) => {
              allMeetings.push({ ...m, projectName: p.name });
            });
          }
        });

        // Render Stats
        statsContent.innerHTML = `
        <div class="insight-stat-item"><span>Pending Actions:</span> <span>${totalPending}</span></div>
        <div class="insight-stat-item" style="color: #a66363"><span>Open Issues:</span> <span>${totalIssues}</span></div>
    `;

        // Render Schedule in proper chronology
        const upcoming = allMeetings
          .filter((m) => new Date(m.date) >= new Date().setHours(0, 0, 0, 0))
          .sort((a, b) => (a.date + a.time).localeCompare(b.date + b.time));

        scheduleContent.innerHTML = upcoming.length
          ? ""
          : "<p style='font-size:11px; opacity:0.5'>No upcoming meetings.</p>";

        upcoming.forEach((m) => {
          const item = document.createElement("div");
          item.className = "chronology-item";
          // Highlight if today
          if (m.date === new Date().toISOString().split("T")[0]) {
            item.style.borderColor = "var(--accent-brown)";
          }

          item.innerHTML = `
            <b>${m.text}</b>
            <span>${formatDisplayDate(m.date)} @ ${m.time}</span>
            <div style="font-size:9px; opacity:0.6">${m.projectName}</div>
        `;
          scheduleContent.appendChild(item);
        });
      }

      function renderDashboard() {
        const grid = document.getElementById("dash-grid");
        grid.innerHTML = "";
        const days = ["S", "M", "T", "W", "T", "F", "S"];
        const today = new Date();
        for (let i = 6; i >= 0; i--) {
          const d = new Date();
          d.setDate(today.getDate() - i);
          const dayLabel = days[d.getDay()];
          const dateKey = d.setHours(0, 0, 0, 0);
          const count = pomoHistory.filter(
            (t) => new Date(t).setHours(0, 0, 0, 0) === dateKey,
          ).length;
          const barHeight = count === 0 ? 4 : Math.min((count / 12) * 40, 40);
          const dayEl = document.createElement("div");
          dayEl.className = "dash-day";
          dayEl.innerHTML = `
            <span class="dash-count">${count}</span>
            <div class="dash-bar"><div class="dash-bar-fill" style="height:${barHeight}px; opacity: ${
              count === 0 ? "0.3" : "1"
            }"></div></div>
            <span class="dash-label">${dayLabel}</span>
        `;
          grid.appendChild(dayEl);
        }
      }

      function render() {
        const grid = document.getElementById("projects-grid");
        grid.innerHTML = "";

        projects.forEach((p) => {
          const el = document.createElement("div");
          el.className = `project-item ${activeId === p.id ? "active" : ""}`;
          el.draggable = true;

          el.onclick = () => {
            activeId = p.id;
            isMarkdownMode = true;
            render();
            switchTab("quests");
          };

          el.ondragstart = (e) => {
            dragSource = { type: "project", id: p.id };
          };
          el.ondragover = (e) => e.preventDefault();
          el.ondrop = (e) => handleDrop(e, p.id, "project");

          // Map members to clickable spans for removal
          const memberHtml = (p.members || [])
            .map(
              (m) =>
                `<span onclick="event.stopPropagation(); removeMember('project', '${p.id}', '${m}')" title="Click to remove">${m}</span>`,
            )
            .join(", ");

          el.innerHTML = `
      <div class="p-title-row">
          <span style="font-weight:700">${p.name}</span>
          <div class="p-actions">
              <button class="btn-icon" style="color:inherit; border:none; background:none; cursor:pointer;" 
                      onclick="event.stopPropagation(); exportSingleProject('${p.id}')">
                  <i class="fas fa-download" title="Export Project"></i>
              </button>
              
              <button class="btn-icon" style="color:inherit; border:none; background:none; cursor:pointer;" 
                      onclick="event.stopPropagation(); addProjectMember('${p.id}')">
                  <i class="fas fa-user-plus" title="Add Member"></i>
              </button>
              
              <button class="btn-icon" style="color:inherit; border:none; background:none; cursor:pointer;" 
                      onclick="event.stopPropagation(); deleteProject('${p.id}')">
                  <i class="fas fa-trash" title="Delete Project"></i>
              </button>
          </div>
      </div>
      <div class="p-meta">
          ${formatDate(p.createdAt)} ‚Ä¢ ${
            p.actions.filter((a) => a.done).length
          }/${p.actions.length} tasks
      </div>
      <div class="p-member-list">
          ${p.members && p.members.length > 0 ? "üë• " + memberHtml : ""}
      </div>`;
          grid.appendChild(el);
        });

        if (activeId) {
          document.getElementById("empty-state").classList.add("hidden");
          document.getElementById("actions-panel").classList.remove("hidden");
          renderActions();
        } else {
          document.getElementById("empty-state").classList.remove("hidden");
          document.getElementById("actions-panel").classList.add("hidden");
        }

        renderGlobalInsights();
        renderDashboard();
        updateTimerDisplay();
      }

      function addIssue() {
        const p = projects.find((x) => x.id === activeId);
        const input = document.getElementById("issue-input");
        if (!input.value.trim()) return;

        if (!p.issues) p.issues = [];

        // STARTING AT 1:
        // We set the default to 1 for the very first issue in a project.
        let nextIdNumber = 1;

        if (p.issues.length > 0) {
          const ids = p.issues.map((i) => {
            // Extract numbers from strings like "#1" or "#10"
            const num = parseInt(i.issueIdDisplay.replace("#", ""));
            return isNaN(num) ? 0 : num;
          });
          // Find the highest number used so far and add 1
          nextIdNumber = Math.max(...ids) + 1;
        }

        const displayId = `#${nextIdNumber}`;

        p.issues.push({
          id: Date.now().toString(),
          issueIdDisplay: displayId,
          text: input.value.trim(),
          status: "open",
          createdAt: new Date().toISOString(),
        });

        input.value = "";
        save();
      }

      function toggleIssueStatus(issueId) {
        const p = projects.find((x) => x.id === activeId);
        const issue = p.issues.find((i) => i.id === issueId);
        issue.status = issue.status === "open" ? "resolved" : "open";
        save();
      }

      function deleteIssue(issueId) {
        const p = projects.find((x) => x.id === activeId);
        p.issues = p.issues.filter((i) => i.id !== issueId);
        save();
      }

      function editIssue(issueId) {
        const p = projects.find((x) => x.id === activeId);
        const issue = p.issues.find((i) => i.id === issueId);
        openBrewModal("Edit Issue", issue.text, (val) => {
          if (val) {
            issue.text = val;
            save();
          }
        });
      }

      function jumpToIssue(displayId) {
        // 1. Switch to the Issues tab
        switchTab("issues");

        // 2. Clear the search input so the target issue isn't filtered out
        const searchInput = document.getElementById("issue-search");
        if (searchInput) {
          searchInput.value = "";
          renderActions();
        }

        // 3. Find the element and scroll to it
        // We'll search for the text content containing our bracketed ID
        setTimeout(() => {
          const issueElements = document.querySelectorAll(
            "#issues-list .task-item",
          );
          for (let el of issueElements) {
            if (el.textContent.includes(`[${displayId}]`)) {
              el.scrollIntoView({ behavior: "smooth", block: "center" });
              // Optional: brief flash effect to highlight it
              el.style.backgroundColor = "rgba(166, 99, 99, 0.2)";
              setTimeout(() => (el.style.backgroundColor = ""), 2000);
              break;
            }
          }
        }, 100);
      }

      // Function to format YYYY-MM-DD to DD-MM-YYYY for display
      function formatDisplayDate(dateStr) {
        if (!dateStr) return "";
        const [year, month, day] = dateStr.split("-");
        return `${day}-${month}-${year}`;
      }

      function addMeeting() {
        const p = projects.find((x) => x.id === activeId);
        const dateIn = document.getElementById("plan-date");
        const timeIn = document.getElementById("plan-time");
        const descIn = document.getElementById("plan-desc");

        if (!dateIn.value || !descIn.value.trim()) return;

        if (!p.meetings) p.meetings = [];

        let rawText = descIn.value.trim();
        let members = [];

        // Regex to detect @mentions
        const mentionRegex = /@(\w+)/g;
        let match;
        while ((match = mentionRegex.exec(rawText)) !== null) {
          members.push(match[1]);
        }

        // Clean the description text by removing the @mentions
        let cleanText = rawText.replace(mentionRegex, "").trim();

        p.meetings.push({
          id: Date.now().toString(),
          date: dateIn.value,
          time: timeIn.value || "00:00",
          text: cleanText,
          members: members, // Added members array
          createdAt: new Date().toISOString(),
        });

        descIn.value = "";
        save();
      }

      function removeMember(type, parentId, memberName) {
        const message = `Remove "${memberName}" from this ${type}?`;
        openBrewModal(
          message,
          "",
          (confirmed) => {
            if (confirmed) {
              const p = projects.find((x) => x.id === activeId);
              if (type === "project") {
                p.members = p.members.filter((m) => m !== memberName);
              } else if (type === "task") {
                const a = p.actions.find((x) => x.id === parentId);
                a.members = a.members.filter((m) => m !== memberName);
              } else if (type === "meeting") {
                // Added meeting support
                const mt = p.meetings.find((x) => x.id === parentId);
                mt.members = mt.members.filter((m) => m !== memberName);
              }
              save();
            }
          },
          false,
        );
      }

      function editMeeting(id) {
        const p = projects.find((x) => x.id === activeId);
        const meeting = p.meetings.find((m) => m.id === id);

        openBrewModal("Edit Meeting Title", meeting.text, (newVal) => {
          if (newVal) {
            meeting.text = newVal;
            save();
          }
        });
      }

      function rescheduleMeeting(id) {
        const p = projects.find((x) => x.id === activeId);
        const meeting = p.meetings.find((m) => m.id === id);

        // Show modal and pre-fill current values
        const modal = document.getElementById("reschedule-modal");
        const dateInput = document.getElementById("resched-date");
        const timeInput = document.getElementById("resched-time");

        dateInput.value = meeting.date;
        timeInput.value = meeting.time;

        modal.classList.remove("hidden");
        isModalOpen = true;

        // Set up the confirm button for this specific meeting
        document.getElementById("resched-confirm-btn").onclick = () => {
          if (dateInput.value) {
            meeting.date = dateInput.value;
            meeting.time = timeInput.value || "00:00";
            save();
            closeRescheduleModal();
          }
        };
      }

      function closeRescheduleModal() {
        document.getElementById("reschedule-modal").classList.add("hidden");
        isModalOpen = false;
      }

      function deleteMeeting(id) {
        const p = projects.find((x) => x.id === activeId);
        p.meetings = p.meetings.filter((m) => m.id !== id);
        save();
      }

      /**
       * Exports a single project as a JSON file
       */
      function exportSingleProject(id) {
        const project = projects.find((p) => p.id === id);
        if (!project) return;

        const blob = new Blob([JSON.stringify(project)], {
          type: "application/json",
        });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `PF_Project_${project.name.replace(/\s+/g, "_")}.json`;
        a.click();
        URL.revokeObjectURL(a.href);
      }

      /**
       * Enhanced Import: Now appends data instead of replacing it
       */
      function importData(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (ev) => {
          try {
            const importedData = JSON.parse(ev.target.result);

            // We use a timestamp + random string to ensure the new IDs never
            // collide with existing projects in your list.
            const generateUniqueId = () =>
              Date.now().toString() + Math.random().toString(36).substr(2, 5);

            // SCENARIO A: The file is a full backup (contains a .projects array)
            if (importedData.projects && Array.isArray(importedData.projects)) {
              importedData.projects.forEach((proj) => {
                proj.id = generateUniqueId(); // Assign new ID to the copy
                projects.push(proj);
              });

              // Also append Pomo history if it exists
              if (
                importedData.pomoHistory &&
                Array.isArray(importedData.pomoHistory)
              ) {
                pomoHistory = [...pomoHistory, ...importedData.pomoHistory];
              }
            }

            // SCENARIO B: The file is a single individual project
            else if (importedData.name && importedData.actions) {
              importedData.id = generateUniqueId(); // Assign new ID to the copy
              projects.push(importedData);
            } else {
              throw new Error("Invalid file format");
            }

            // Save to LocalStorage and Refresh
            localStorage.setItem("pf-v12", JSON.stringify(projects));
            localStorage.setItem("pf-pomo-v12", JSON.stringify(pomoHistory));

            alert("Projects imported and appended successfully!");
            location.reload(); // Refresh to show new items
          } catch (err) {
            console.error("Import Error:", err);
            alert(
              "Failed to import. Please check if the file is a valid Project Flow JSON.",
            );
          }
        };
        reader.readAsText(file);
      }

      function handleImport(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (ev) => {
          try {
            const data = JSON.parse(ev.target.result);

            // Helper to generate a fresh ID to avoid conflicts with existing projects
            const generateNewId = () =>
              Date.now().toString() + Math.random().toString(36).substr(2, 5);

            // SCENARIO 1: It's a full backup file (contains .projects array)
            if (data.projects && Array.isArray(data.projects)) {
              data.projects.forEach((proj) => {
                proj.id = generateNewId();
                projects.push(proj);
              });
              // Append Pomo history if present
              if (data.pomoHistory) {
                pomoHistory = [...pomoHistory, ...data.pomoHistory];
              }
            }

            // SCENARIO 2: It's a single project file
            else if (data.name && data.actions) {
              const singleProj = data;
              singleProj.id = generateNewId();
              projects.push(singleProj);
            } else {
              alert(
                "The file format is not recognized as a Project Flow export.",
              );
              return;
            }

            // 1. Save the newly appended list to local storage
            localStorage.setItem("pf-v12", JSON.stringify(projects));
            localStorage.setItem("pf-pomo-v12", JSON.stringify(pomoHistory));

            // 2. Clear the input value so the same file can be imported again if desired
            e.target.value = "";

            // 3. Inform the user and refresh the UI
            alert("Project(s) imported and appended successfully!");
            render(); // Refresh the sidebar list
          } catch (err) {
            console.error("Import failed:", err);
            alert(
              "Failed to parse the JSON file. Please ensure it's a valid export.",
            );
          }
        };
        reader.readAsText(file);
      }

      function addLearning() {
        const p = projects.find((x) => x.id === activeId);
        const descInput = document.getElementById("learning-desc-input");

        if (!descInput.value.trim()) return;

        if (!p.events) p.events = [];

        // Get today's date in YYYY-MM-DD format automatically
        const today = new Date().toISOString().split("T")[0];

        p.events.push({
          id: Date.now().toString(),
          date: today, // Automatically assigned
          text: descInput.value.trim(),
          createdAt: new Date().toISOString(),
        });

        descInput.value = "";
        save();
      }

      function editLearning(id) {
        const p = projects.find((x) => x.id === activeId);
        const item = p.events.find((e) => e.id === id);
        openBrewModal("Edit Insight", item.text, (val) => {
          if (val) {
            item.text = val;
            save();
          }
        });
      }

      function deleteLearning(id) {
        const p = projects.find((x) => x.id === activeId);
        if (!p || !p.events) return;

        // Using openBrewModal as a confirmation dialog (isPrompt = false)
        openBrewModal(
          "Delete this learning?",
          "",
          (confirmed) => {
            if (confirmed) {
              p.events = p.events.filter((e) => e.id !== id);
              save();
            }
          },
          false,
        );
      }

      function linkify(text) {
        if (!text) return "";
        return text.replace(/(#\d+)/g, (match) => {
          return `<span class="issue-link" 
            onclick="event.stopPropagation(); hideIssueTooltip(); jumpToIssue('${match}')" 
            onmouseenter="showIssueTooltip(event, '${match}')" 
            onmousemove="moveIssueTooltip(event)"
            onmouseleave="hideIssueTooltip()"
            style="color:var(--accent-brown); cursor:pointer; text-decoration:underline; font-weight:bold;">${match}</span>`;
        });
      }
      let currentTooltip = null;

      function showIssueTooltip(event, displayId) {
        hideIssueTooltip();

        const p = projects.find((x) => x.id === activeId);
        const issue = p.issues
          ? p.issues.find((i) => i.issueIdDisplay === displayId)
          : null;

        currentTooltip = document.createElement("div");
        currentTooltip.className = "issue-tooltip";

        if (issue) {
          const statusColor =
            issue.status === "resolved" ? "var(--success-green)" : "#a66363";
          currentTooltip.innerHTML = `
      <span class="tooltip-status" style="color: ${statusColor}">${issue.status}</span>
      <strong style="display:block; margin-bottom:4px;">${issue.text}</strong>
      <small style="opacity:0.6; font-size:9px;">Created: ${formatDate(issue.createdAt)}</small>
    `;
        } else {
          currentTooltip.innerHTML = `<i style="opacity:0.6">Quest not found</i>`;
        }

        document.body.appendChild(currentTooltip);
        moveIssueTooltip(event); // Initial position
      }

      function moveIssueTooltip(event) {
        if (currentTooltip) {
          const offset = 15;
          // Use clientX/Y for positioning relative to the viewport
          currentTooltip.style.left = `${event.clientX + offset}px`;
          currentTooltip.style.top = `${event.clientY + offset}px`;
        }
      }

      function hideIssueTooltip() {
        if (currentTooltip) {
          currentTooltip.remove();
          currentTooltip = null;
        }
      }

      function renderActions() {
        const p = projects.find((x) => x.id === activeId);
        if (!p) return;

        // 1. Capture All Search Values
        const actionSearch = document.getElementById("action-search")
          ? document.getElementById("action-search").value.toLowerCase()
          : "";
        const issueSearch = document.getElementById("issue-search")
          ? document.getElementById("issue-search").value.toLowerCase()
          : "";
        const learningSearch = document.getElementById("learning-search")
          ? document.getElementById("learning-search").value.toLowerCase()
          : "";
        const planSearch = document.getElementById("plan-search")
          ? document.getElementById("plan-search").value.toLowerCase()
          : "";

        // 2. Update Header Title
        const panelTitle = document.getElementById("panel-title");
        if (panelTitle) panelTitle.innerText = p.name;

        // 3. Handle Project Description (Goal) & Copy Button
        let descContainer = document.getElementById("desc-container");
        if (!descContainer) {
          descContainer = document.createElement("div");
          descContainer.id = "desc-container";
          descContainer.style =
            "display: flex; align-items: center; gap: 10px; margin-top: 8px; width: 100%;";

          const descText = document.createElement("div");
          descText.id = "project-description";
          descText.style =
            "font-size: 14px; color: var(--accent-brown); opacity: 0.8; cursor: pointer; font-style: italic; line-height: 1.4; flex: 1;";
          descText.onclick = editProjectDescription;

          const copyBtn = document.createElement("button");
          copyBtn.id = "copy-desc-btn";
          copyBtn.className = "btn-toggle-icon";
          copyBtn.style =
            "width: 28px; height: 28px; font-size: 11px; flex-shrink: 0; background: rgba(192, 160, 128, 0.2); color: var(--accent-brown);";
          copyBtn.innerHTML = '<i class="fas fa-copy"></i>';
          copyBtn.title = "Copy Description";

          descContainer.appendChild(copyBtn);
          descContainer.appendChild(descText);
          if (panelTitle) panelTitle.after(descContainer);
        }

        const projDesc = document.getElementById("project-description");
        if (projDesc)
          projDesc.innerText =
            p.description || "Click to add a project goal or description...";

        const copyDescBtn = document.getElementById("copy-desc-btn");
        if (copyDescBtn) {
          copyDescBtn.onclick = () =>
            copyToClipboard(p.description || "", copyDescBtn);
        }

        // 4. Project Stats
        const statsEl = document.getElementById("project-stats");
        if (statsEl) {
          const totalTime = p.actions
            ? p.actions.reduce((s, a) => s + (a.timeSpent || 0), 0)
            : 0;
          statsEl.innerHTML = `Created: ${formatDate(p.createdAt)} ‚Ä¢ Total Session: ${formatTime(totalTime)}`;
        }

        // 5. Render Notes Tab
        const notesArea = document.getElementById("notes-area");
        const markdownView = document.getElementById("markdown-view");
        const toggleIcon = document.getElementById("toggle-icon");

        if (notesArea && markdownView) {
          const rawNotes = p.notes || DEFAULT_MD;
          notesArea.value = rawNotes;
          if (isMarkdownMode) {
            markdownView.innerHTML = marked.parse(linkify(rawNotes));
            markdownView.classList.remove("hidden");
            notesArea.classList.add("hidden");
            if (toggleIcon) toggleIcon.className = "fas fa-pen";
          } else {
            markdownView.classList.add("hidden");
            notesArea.classList.remove("hidden");
            if (toggleIcon) toggleIcon.className = "fas fa-eye";
          }
        }

        // 6. Render Tasks (Actions Tab)
        const activeList = document.getElementById("active-actions");
        const archList = document.getElementById("archived-actions");
        if (activeList && archList) {
          activeList.innerHTML = "";
          archList.innerHTML = "";

          (p.actions || []).forEach((a) => {
            if (!a.text.toLowerCase().includes(actionSearch)) return;

            const row = document.createElement("div");
            row.className = "task-item";
            row.draggable = true;
            row.ondragstart = (e) => {
              dragSource = { type: "task", id: a.id };
            };
            row.ondragover = (e) => e.preventDefault();
            row.ondrop = (e) => handleDrop(e, a.id, "task");

            const taskMemberHtml = (a.members || [])
              .map(
                (m) =>
                  `<span onclick="removeMember('task', '${a.id}', '${m}')" style="cursor:pointer; text-decoration:underline;" title="Click to remove">${m}</span>`,
              )
              .join(", ");

            row.innerHTML = `
          <div class="drag-handle" style="cursor:grab; opacity:0.3">::</div>
          <input type="checkbox" ${a.done ? "checked" : ""} onchange="toggleAction('${a.id}')">
          <div style="flex: 1; display: flex; flex-direction: column;">
              <span class="task-text ${a.done ? "done" : ""}" onclick="editActionText('${a.id}')">
                  ${linkify(a.text)} 
                  <small style="font-size: 10px; opacity: 0.5; margin-left: 8px;">${formatDate(a.createdAt)}</small>
              </span>
              <small class="task-assignees" style="font-size: 10px; color: var(--accent-brown); font-weight: bold; margin-top: 2px;">
                  ${a.members && a.members.length > 0 ? "Assigned: " + taskMemberHtml : ""}
              </small>
          </div>
          <span style="font-size:11px; font-weight:700; color:var(--muted-tan); cursor:pointer" onclick="logManualTime('${a.id}')">
              ${formatTime(a.timeSpent)}
          </span>
          <button style="border:none; background:none; color:var(--muted-tan); cursor:pointer; padding: 0 10px;" onclick="addTaskMember('${a.id}')">
              <i class="fas fa-user-plus"></i>
          </button>
          <button style="border:none; background:none; color:var(--muted-tan); cursor:pointer;" onclick="deleteAction('${a.id}')">
              <i class="fas fa-times"></i>
          </button>`;
            (a.done ? archList : activeList).appendChild(row);
          });
        }

        // 7. Render Learnings Tab
        const learningsList = document.getElementById("learnings-list");
        if (learningsList) {
          learningsList.innerHTML = "";
          const filtered = (p.events || [])
            .filter((e) => e.text.toLowerCase().includes(learningSearch))
            .sort((a, b) => new Date(b.date) - new Date(a.date));

          filtered.forEach((e) => {
            const row = document.createElement("div");
            row.className = "task-item";
            row.innerHTML = `
          <div style="display: flex; align-items: flex-start; gap: 15px; flex: 1; cursor: pointer;" onclick="editLearning('${e.id}')">
              <i class="fas fa-lightbulb" style="color: #e6b800; margin-top: 5px;"></i>
              <div style="flex: 1;">
                  <div style="font-size: 11px; font-weight: 800; color: var(--muted-tan); text-transform: uppercase;">${formatDisplayDate(e.date)}</div>
                  <div style="font-size: 16px; font-weight: 600; color: var(--primary-dark); line-height: 1.4;">${linkify(e.text)}</div>
              </div>
          </div>
          <button style="border:none; background:none; color:var(--muted-tan); cursor:pointer; padding: 10px;" onclick="deleteLearning('${e.id}')">
              <i class="fas fa-trash-alt"></i>
          </button>`;
            learningsList.appendChild(row);
          });
        }

        // 8. Render Quests Tab (Formerly Issues)
        const questsList = document.getElementById("issues-list");
        if (questsList) {
          questsList.innerHTML = "";
          const filteredIssues = (p.issues || [])
            .filter(
              (i) =>
                i.text.toLowerCase().includes(issueSearch) ||
                (i.issueIdDisplay &&
                  i.issueIdDisplay.toLowerCase().includes(issueSearch)),
            )
            .sort((a, b) => {
              if (a.status === "open" && b.status === "resolved") return -1;
              if (a.status === "resolved" && b.status === "open") return 1;
              return new Date(b.createdAt) - new Date(a.createdAt);
            });

          filteredIssues.forEach((i) => {
            const isResolved = i.status === "resolved";
            const row = document.createElement("div");
            row.className = "task-item";
            row.style.borderLeft = isResolved
              ? "4px solid var(--success-green)"
              : "4px solid #a66363";
            row.style.paddingLeft = "12px";
            row.style.background = isResolved
              ? "rgba(255,255,255,0.3)"
              : "transparent";

            row.innerHTML = `
          <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
              <button onclick="toggleIssueStatus('${i.id}')" style="border:none; background:none; cursor:pointer; color:${isResolved ? "var(--success-green)" : "#a66363"}">
                  <i class="fas ${isResolved ? "fa-check-circle" : "fa-exclamation-circle"} fa-lg"></i>
              </button>
              <div style="flex: 1; cursor: pointer; ${isResolved ? "opacity: 0.5; text-decoration: line-through;" : ""}" onclick="editIssue('${i.id}')">
                  <div style="font-size: 15px; font-weight: 700; color: var(--primary-dark);">
                      <span style="font-family: 'Special Elite', monospace; color: var(--accent-brown); margin-right: 8px;">[${i.issueIdDisplay}]</span>
                      ${i.text}
                  </div>
                  <div style="font-size: 10px; color: var(--muted-tan); text-transform: uppercase; font-weight:bold;">${formatDate(i.createdAt)}</div>
              </div>
          </div>
          <div class="issue-menu-container">
              <button class="menu-trigger" onclick="toggleIssueMenu(event, '${i.id}')">
                  <i class="fas fa-ellipsis-v"></i>
              </button>
              <div id="dropdown-${i.id}" class="issue-dropdown">
                  <div class="menu-item" onclick="convertIssueTo('${i.id}', 'task')"><i class="fas fa-tasks"></i> Create Action</div>
                  <div class="menu-item" onclick="convertIssueTo('${i.id}', 'learning')"><i class="fas fa-lightbulb"></i> Log Learnings</div>
                  <div class="menu-item" onclick="convertIssueTo('${i.id}', 'meeting')"><i class="fas fa-calendar-alt"></i> Schedule Meeting</div>
                  <div class="menu-item delete-item" onclick="deleteIssue('${i.id}')"><i class="fas fa-trash-alt"></i> Delete Quest</div>
              </div>
          </div>`;
            questsList.appendChild(row);
          });
        }

        // 9. Render Meetings Tab (Formerly Planner)
        const meetingsList = document.getElementById("meetings-list");
        if (meetingsList) {
          meetingsList.innerHTML = "";
          const todayStr = new Date().toISOString().split("T")[0];
          const filtered = (p.meetings || [])
            .filter((m) => m.text.toLowerCase().includes(planSearch))
            .sort((a, b) => (a.date + a.time).localeCompare(b.date + b.time));

          filtered.forEach((m) => {
            const isToday = m.date === todayStr;
            const row = document.createElement("div");
            row.className = "task-item";

            // Removed the background color logic here
            if (isToday) {
              // We keep the border-left to give a subtle "Today" indicator without a bulky background
              row.style.borderLeft = "4px solid var(--accent-brown)";
              row.style.paddingLeft = "10px";
            }

            const mHtml = (m.members || [])
              .map(
                (name) =>
                  `<span onclick="event.stopPropagation(); removeMember('meeting', '${m.id}', '${name}')" style="cursor:pointer; text-decoration:underline;">${name}</span>`,
              )
              .join(", ");

            row.innerHTML = `
            <div style="display: flex; align-items: center; gap: 15px; flex: 1; cursor: pointer;" onclick="editMeeting('${m.id}')">
                <div style="min-width: 50px; text-align: center; font-family: 'Special Elite', cursive; color: var(--accent-brown);">
                    <div style="font-size: 10px; opacity: 0.7;">${new Date(m.date).toLocaleString("default", { month: "short" })}</div>
                    <div style="font-size: 18px; font-weight: bold;">${m.date.split("-")[2]}</div>
                </div>
                <div style="flex: 1;">
                    <div style="font-size: 11px; font-weight: 800; color: var(--muted-tan);"><i class="far fa-clock"></i> ${m.time}</div>
                    <div style="font-size: 16px; font-weight: 600; color: var(--primary-dark);">${linkify(m.text)}</div>
                    <small style="font-size: 10px; color: var(--accent-brown); font-weight: bold;">${m.members && m.members.length > 0 ? "üë• " + mHtml : ""}</small>
                </div>
            </div>
            <div style="display: flex; gap: 10px;">
                <button style="border:none; background:none; color:var(--muted-tan); cursor:pointer;" onclick="rescheduleMeeting('${m.id}')"><i class="fas fa-calendar-alt"></i></button>
                <button style="border:none; background:none; color:var(--muted-tan); cursor:pointer;" onclick="deleteMeeting('${m.id}')"><i class="fas fa-trash-alt"></i></button>
            </div>`;
            meetingsList.appendChild(row);
          });
        }

        // 10. Sync Global Elements
        renderGlobalInsights();
      }
      // Toggle the visibility of the three-dot menu
      function toggleIssueMenu(event, id) {
        event.stopPropagation();
        // Close all other open dropdowns first
        document.querySelectorAll(".issue-dropdown").forEach((d) => {
          if (d.id !== `dropdown-${id}`) d.classList.remove("show");
        });
        document.getElementById(`dropdown-${id}`).classList.toggle("show");
      }

      // Global click listener to close menu when clicking outside
      window.addEventListener("click", () => {
        document
          .querySelectorAll(".issue-dropdown")
          .forEach((d) => d.classList.remove("show"));
      });

      // Conversion Logic
      function convertIssueTo(issueId, type) {
        const p = projects.find((x) => x.id === activeId);
        const issue = p.issues.find((i) => i.id === issueId);
        const ref = issue.issueIdDisplay; // The #101

        let targetTab = "";
        let inputId = "";

        switch (type) {
          case "task":
            targetTab = "tasks";
            inputId = "action-input";
            break;
          case "learning":
            targetTab = "learnings";
            inputId = "learning-desc-input";
            break;
          case "meeting":
            targetTab = "meetings"; // Updated from 'planner'
            inputId = "plan-desc";
            break;
        }

        // 1. Switch the UI to the correct notebook tab
        switchTab(targetTab);

        // 2. Locate the specific input field
        const inputField = document.getElementById(inputId);
        if (inputField) {
          // 3. Pre-fill the input with the Quest reference ID
          inputField.value = `[${ref}] `;

          // 4. Focus and move cursor to end
          setTimeout(() => {
            inputField.focus();
            const val = inputField.value;
            inputField.value = "";
            inputField.value = val;
          }, 100);
        }
      }

      function toggleMarkdown() {
        isMarkdownMode = !isMarkdownMode;
        renderActions();
      }

      function handleDrop(e, targetId, type) {
        e.preventDefault();
        if (!dragSource || dragSource.type !== type) return;
        let list =
          type === "project"
            ? projects
            : projects.find((x) => x.id === activeId).actions;
        const fromIdx = list.findIndex((x) => x.id === dragSource.id),
          toIdx = list.findIndex((x) => x.id === targetId);
        const [moved] = list.splice(fromIdx, 1);
        list.splice(toIdx, 0, moved);
        save();
      }

      function formatTime(s) {
        const m = Math.floor((s || 0) / 60);
        return m > 60 ? `${Math.floor(m / 60)}h ${m % 60}m` : `${m}m`;
      }
      function logManualTime(aId) {
        openBrewModal("Log Time", "25", (val) => {
          if (val) {
            const a = projects
              .find((x) => x.id === activeId)
              .actions.find((x) => x.id === aId);
            a.timeSpent = (a.timeSpent || 0) + parseInt(val) * 60;
            save();
          }
        });
      }
      function editActiveProjectName() {
        const p = projects.find((x) => x.id === activeId);
        openBrewModal("Rename Project", p.name, (n) => {
          if (n) {
            p.name = n;
            save();
          }
        });
      }
      function editActionText(id) {
        const a = projects
          .find((x) => x.id === activeId)
          .actions.find((x) => x.id === id);
        openBrewModal("Edit Task", a.text, (n) => {
          if (n) {
            a.text = n;
            save();
          }
        });
      }
      function deleteProject(id) {
        openBrewModal(
          "Remove this project?",
          "",
          (confirmed) => {
            if (confirmed) {
              projects = projects.filter((p) => p.id !== id);
              if (activeId === id) activeId = null;
              save();
            }
          },
          false,
        );
      }
      function toggleAction(id) {
        const a = projects
          .find((x) => x.id === activeId)
          .actions.find((x) => x.id === id);
        a.done = !a.done;
        save();
      }
      function deleteAction(id) {
        const p = projects.find((x) => x.id === activeId);
        p.actions = p.actions.filter((a) => a.id !== id);
        save();
      }
      function updateNotes() {
        const p = projects.find((x) => x.id === activeId);
        p.notes = document.getElementById("notes-area").value;
        localStorage.setItem("pf-v12", JSON.stringify(projects));
      }

      function renderGlobalInsights() {
        const statsContent = document.getElementById("global-stats-content");
        const scheduleContent = document.getElementById(
          "global-schedule-content",
        );

        if (!statsContent || !scheduleContent) return;

        let totalPendingActions = 0;
        let totalOpenIssues = 0;
        let allMeetings = [];
        const todayStr = new Date().toISOString().split("T")[0];

        // 1. Aggregate data from every project
        projects.forEach((p) => {
          // Count tasks not marked as 'done'
          totalPendingActions += (p.actions || []).filter(
            (a) => !a.done,
          ).length;

          // Count issues marked as 'open'
          totalOpenIssues += (p.issues || []).filter(
            (i) => i.status === "open",
          ).length;

          // Collect all meetings and tag them with their project name/ID for navigation
          if (p.meetings) {
            p.meetings.forEach((m) => {
              allMeetings.push({
                ...m,
                projectName: p.name,
                projectId: p.id,
              });
            });
          }
        });

        // 2. Render the Global Stats
        statsContent.innerHTML = `
        <div class="insight-stat-item">
            <span>Pending Actions</span>
            <span>${totalPendingActions}</span>
        </div>
        <div class="insight-stat-item" style="color: ${totalOpenIssues > 0 ? "#a66363" : "var(--muted-tan)"}">
            <span>Open Issues</span>
            <span>${totalOpenIssues}</span>
        </div>
    `;

        // 3. Process and Sort Master Schedule
        // Filter out past meetings (older than today) and sort by date then time
        const upcoming = allMeetings
          .filter((m) => m.date >= todayStr)
          .sort((a, b) => (a.date + a.time).localeCompare(b.date + b.time));

        // Clear previous list
        scheduleContent.innerHTML = upcoming.length
          ? ""
          : "<p style='font-size:11px; opacity:0.5; text-align:center;'>No upcoming meetings.</p>";

        // 4. Render Chronological Items
        upcoming.forEach((m) => {
          const item = document.createElement("div");
          item.className = "chronology-item";

          // Highlight logic for today's meetings
          if (m.date === todayStr) {
            item.style.borderColor = "var(--success-green)";
            item.style.background = "rgba(122, 154, 101, 0.05)";
          }

          // Action: Click to switch to that project and open the Planner tab
          item.onclick = () => {
            activeId = m.projectId;
            render(); // This will refresh the sidebar and main view
            switchTab("planner");

            // Optional: Smooth scroll the meeting into view in the main notebook
            setTimeout(() => {
              const target = document.querySelector(
                `#planner-list [onclick*="${m.id}"]`,
              );
              if (target)
                target.scrollIntoView({ behavior: "smooth", block: "center" });
            }, 100);
          };

          item.innerHTML = `
            <b>${m.text}</b>
            <span>${m.time} ‚Ä¢ ${formatDisplayDate(m.date)}</span>
            <div style="font-size:9px; opacity:0.6; text-transform:uppercase; letter-spacing:0.5px; margin-top:2px;">
                <i class="fas fa-folder-open" style="font-size:8px;"></i> ${m.projectName}
            </div>
        `;
          scheduleContent.appendChild(item);
        });
      }

      // Function to add a project member
      function addProjectMember(projId) {
        openBrewModal("Add Project Member", "", (name) => {
          if (name && name.trim() !== "") {
            const p = projects.find((x) => x.id === projId);
            if (!p.members) p.members = [];
            p.members.push(name.trim());
            save();
          }
        });
      }

      // Function to remove a member (Project or Task)
      function removeMember(type, parentId, memberName) {
        const message = `Remove "${memberName}" from this ${type}?`;
        openBrewModal(
          message,
          "",
          (confirmed) => {
            if (confirmed) {
              if (type === "project") {
                const p = projects.find((x) => x.id === parentId);
                p.members = p.members.filter((m) => m !== memberName);
              } else {
                const p = projects.find((x) => x.id === activeId);
                const a = p.actions.find((x) => x.id === parentId);
                a.members = a.members.filter((m) => m !== memberName);
              }
              save();
            }
          },
          false,
        ); // false means it's a confirmation, not a text input
      }

      // Function to add a task member
      function addTaskMember(taskId) {
        openBrewModal("Assign Person to Task", "", (name) => {
          if (name && name.trim() !== "") {
            const p = projects.find((x) => x.id === activeId);
            const a = p.actions.find((x) => x.id === taskId);
            if (!a.members) a.members = [];
            a.members.push(name.trim());
            save();
          }
        });
      }

      function exportData() {
        const now = new Date();

        // Extract date components
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, "0");
        const day = String(now.getDate()).padStart(2, "0");

        // Extract time components
        const hours = String(now.getHours()).padStart(2, "0");
        const mins = String(now.getMinutes()).padStart(2, "0");

        // Construct the readable filename
        const datestring = `${year}-${month}-${day}_${hours}-${mins}`;

        const blob = new Blob([JSON.stringify({ projects, pomoHistory })], {
          type: "application/json",
        });

        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `projectflow_backup_${datestring}.json`;
        a.click();

        // Clean up the URL object to free up memory
        URL.revokeObjectURL(a.href);
      }

      function importData(e) {
        const reader = new FileReader();
        reader.onload = (ev) => {
          const d = JSON.parse(ev.target.result);
          projects = d.projects || [];
          pomoHistory = d.pomoHistory || [];
          save();
          location.reload();
        };
        reader.readAsText(e.target.files[0]);
      }

      function formatDate(isoString) {
        if (!isoString) return "";
        const date = new Date(isoString);
        return date.toLocaleDateString(undefined, {
          month: "short",
          day: "numeric",
        });
      }

      function switchTab(t) {
        // Updated list of tab names
        const tabs = ["quests", "tasks", "learnings", "notes", "meetings"];
        tabs.forEach((tab) => {
          const tabBtn = document.getElementById(`tab-${tab}`);
          const content = document.getElementById(`${tab}-content`);
          if (tabBtn) tabBtn.classList.toggle("active", t === tab);
          if (content) content.classList.toggle("hidden", t !== tab);
        });

        if (t === "meetings") {
          document.getElementById("plan-date").valueAsDate = new Date();
        }
        renderActions();
      }

      async function copyToClipboard(text, btnElement) {
        try {
          await navigator.clipboard.writeText(text);

          // Get the icon inside the button to give feedback
          const icon = btnElement.querySelector("i");
          const originalClass = icon.className;

          // Change icon to a checkmark and turn the button green
          icon.className = "fas fa-check";
          btnElement.style.background = "var(--success-green)";
          btnElement.style.color = "white";

          // Revert back to original state after 2 seconds
          setTimeout(() => {
            icon.className = originalClass;
            btnElement.style.background = "";
            btnElement.style.color = "";
          }, 2000);
        } catch (err) {
          console.error("Failed to copy: ", err);
        }
      }

      function editProjectDescription() {
        const p = projects.find((x) => x.id === activeId);
        openBrewModal(
          "Project Goal / Description",
          p.description || "",
          (val) => {
            if (val !== null) {
              p.description = val;
              save();
            }
          },
        );
      }

      function handleGlobalKeys(e) {
        // 1. If a modal is open, Escape should only close the modal
        if (e.key === "Escape" && isModalOpen) {
          closeModal();
          closeGuide();
          return;
        }

        // 2. Handle Escape for Unfocusing
        if (e.key === "Escape") {
          // If we are currently typing in an input or textarea
          if (["INPUT", "TEXTAREA"].includes(document.activeElement.tagName)) {
            document.activeElement.blur(); // Just remove focus from the text field
          } else {
            // If no input is focused, then we clear the active project selection
            activeId = null;
            render();
          }
          return;
        }

        // 3. Global Shortcut: Jump to New Project Input [/]
        if (
          e.key === "/" &&
          !["INPUT", "TEXTAREA"].includes(document.activeElement.tagName)
        ) {
          e.preventDefault();
          document.getElementById("project-input").focus();
          return;
        }

        // 4. NEW Global Shortcut: Focus Search Box in current tab [\]
        if (
          e.key === "\\" &&
          !["INPUT", "TEXTAREA"].includes(document.activeElement.tagName)
        ) {
          e.preventDefault();
          if (activeId) {
            const activeTabBtn = document.querySelector(".tab.active");
            if (activeTabBtn) {
              const currentTabId = activeTabBtn.id.replace("tab-", "");
              const searchInputMap = {
                quests: "issue-input",
                tasks: "action-search",
                learnings: "learning-search",
                meetings: "plan-search",
              };

              const targetSearchId = searchInputMap[currentTabId];
              const searchInput = document.getElementById(targetSearchId);
              if (searchInput) {
                searchInput.focus();
                // Optional: selects existing text so you can overwrite immediately
                searchInput.select();
              }
            }
          }
          return;
        }

        // 5. Contextual Navigation (Only active when NOT typing)
        if (!["INPUT", "TEXTAREA"].includes(document.activeElement.tagName)) {
          // [Enter] to jump into the current tab's primary input
          if (e.key === "Enter" && activeId) {
            e.preventDefault();
            const currentTabBtn = document.querySelector(".tab.active");
            if (currentTabBtn) {
              const currentTabId = currentTabBtn.id.replace("tab-", "");
              const inputMap = {
                quests: "issue-input",
                tasks: "action-input",
                learnings: "learning-desc-input",
                notes: "notes-area",
                meetings: "plan-desc",
              };
              const targetInputId = inputMap[currentTabId];
              if (targetInputId) document.getElementById(targetInputId).focus();
            }
            return;
          }

          // [Left/Right] arrows: Switch Tabs
          const tabOrder = [
            "quests",
            "tasks",
            "learnings",
            "notes",
            "meetings",
          ];
          if (activeId && (e.key === "ArrowLeft" || e.key === "ArrowRight")) {
            e.preventDefault();
            const currentTabBtn = document.querySelector(".tab.active");
            if (currentTabBtn) {
              const currentTabId = currentTabBtn.id.replace("tab-", "");
              let currentIndex = tabOrder.indexOf(currentTabId);
              if (e.key === "ArrowRight") {
                currentIndex = (currentIndex + 1) % tabOrder.length;
              } else {
                currentIndex =
                  (currentIndex - 1 + tabOrder.length) % tabOrder.length;
              }
              switchTab(tabOrder[currentIndex]);
            }
          }

          // [Up/Down] arrows: Switch Projects
          if (e.key === "ArrowDown" || e.key === "ArrowUp") {
            e.preventDefault();
            const idx = projects.findIndex((p) => p.id === activeId);
            let newActiveId = null;

            if (e.key === "ArrowDown") {
              if (idx === -1 && projects.length > 0)
                newActiveId = projects[0].id;
              else if (idx < projects.length - 1)
                newActiveId = projects[idx + 1].id;
            } else if (e.key === "ArrowUp" && idx > 0) {
              newActiveId = projects[idx - 1].id;
            }

            if (newActiveId) {
              activeId = newActiveId;
              render(); // Re-renders the list to apply the .active class

              // --- SCROLL INTO VIEW LOGIC ---
              // We wait a tiny bit for the render to finish, then find the element
              setTimeout(() => {
                const activeEl = document.querySelector(".project-item.active");
                if (activeEl) {
                  activeEl.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest", // "nearest" prevents the whole page from jumping
                  });
                }
              }, 10);
              // ------------------------------

              const currentTabBtn = document.querySelector(".tab.active");
              const currentTabId = currentTabBtn
                ? currentTabBtn.id.replace("tab-", "")
                : "quests";
              switchTab(currentTabId);
            }
          }
        }
      }

      function save() {
        localStorage.setItem("pf-v12", JSON.stringify(projects));
        localStorage.setItem("pf-pomo-v12", JSON.stringify(pomoHistory));
        render();
      }

      document.getElementById("project-input").onkeydown = (e) => {
        if (e.key === "Enter" && e.target.value) {
          let rawText = e.target.value;
          let members = [];
          const mentionRegex = /@(\w+)/g;
          let match;

          while ((match = mentionRegex.exec(rawText)) !== null) {
            members.push(match[1]);
          }

          let cleanText = rawText.replace(mentionRegex, "").trim();
          const id = Date.now().toString();

          projects.push({
            id,
            name: cleanText,
            actions: [],
            members: members,
            description: "Click to add a project goal or description...", // Added this line
            notes: DEFAULT_MD,
            createdAt: new Date().toISOString(),
          });

          activeId = id;
          e.target.value = "";
          save();
        }
      };
      document.getElementById("action-input").onkeydown = (e) => {
        if (e.key === "Enter" && e.target.value) {
          let rawText = e.target.value;
          let members = [];

          // Regex to find all @names (e.g., @Sarah @John)
          const mentionRegex = /@(\w+)/g;
          let match;

          while ((match = mentionRegex.exec(rawText)) !== null) {
            members.push(match[1]); // match[1] is the name without the @
          }

          // Clean the text by removing the @mentions and extra spaces
          let cleanText = rawText.replace(mentionRegex, "").trim();

          projects
            .find((x) => x.id === activeId)
            .actions.push({
              id: Date.now().toString(),
              text: cleanText,
              done: false,
              members: members, // Automatically populated from the @mentions
              timeSpent: 0,
              createdAt: new Date().toISOString(),
            });

          e.target.value = "";
          save();
        }
      };

      init();
    </script>
  </body>
</html>
